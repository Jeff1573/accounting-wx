# 部署指南

本文档提供记账小程序的完整部署步骤。

## 一、服务器准备

### 1. 服务器要求
- 操作系统：Ubuntu 20.04+ / CentOS 7+
- 内存：至少 1GB
- 硬盘：至少 10GB
- 需要开放端口：3000（后端）、3306（MySQL，仅内网）

### 2. 安装 Node.js

```bash
# 安装 Node.js 16+
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node -v
npm -v
```

### 3. 安装 MySQL

```bash
# 安装 MySQL 8.0
sudo apt-get update
sudo apt-get install mysql-server

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

### 4. 配置防火墙

```bash
# 开放后端端口（如果使用 Nginx 反向代理，可不开放）
sudo ufw allow 3000

# 开放 HTTP 和 HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 启用防火墙
sudo ufw enable
```

## 二、数据库配置

### 1. 创建数据库

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE accounting_miniapp CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建数据库用户
CREATE USER 'accounting_user'@'localhost' IDENTIFIED BY 'your_strong_password';
GRANT ALL PRIVILEGES ON accounting_miniapp.* TO 'accounting_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 2. 导入数据库结构

```bash
# 上传 数据库初始化.sql 到服务器
# 执行初始化脚本
mysql -u accounting_user -p accounting_miniapp < 数据库初始化.sql
```

## 三、后端部署

### 1. 上传代码

```bash
# 在服务器上创建项目目录
mkdir -p /var/www/accounting-miniapp
cd /var/www/accounting-miniapp

# 上传 backend 目录到服务器
# 可以使用 scp、git 或其他方式
```

### 2. 安装依赖

```bash
cd /var/www/accounting-miniapp/backend
npm install --production
```

### 3. 配置环境变量

```bash
# 创建 .env 文件
cp env.template .env
nano .env

# 修改以下配置：
# PORT=3000
# NODE_ENV=production
# DB_HOST=localhost
# DB_PORT=3306
# DB_NAME=accounting_miniapp
# DB_USER=accounting_user
# DB_PASSWORD=your_strong_password
# JWT_SECRET=your_random_jwt_secret
# WX_APPID=your_wechat_appid
# WX_SECRET=your_wechat_appsecret
```

### 4. 编译 TypeScript

```bash
npm run build
```

### 5. 使用 PM2 管理进程

```bash
# 安装 PM2
sudo npm install -g pm2

# 启动应用
pm2 start dist/app.js --name accounting-backend

# 设置开机自启
pm2 startup
pm2 save

# 查看日志
pm2 logs accounting-backend

# 其他常用命令
pm2 restart accounting-backend  # 重启
pm2 stop accounting-backend     # 停止
pm2 delete accounting-backend   # 删除
```

## 四、Nginx 配置（可选但推荐）

### 1. 安装 Nginx

```bash
sudo apt-get install nginx
```

### 2. 配置反向代理

```bash
# 创建配置文件
sudo nano /etc/nginx/sites-available/accounting-miniapp

# 添加以下内容：
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}

# 启用配置
sudo ln -s /etc/nginx/sites-available/accounting-miniapp /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 3. 配置 HTTPS（使用 Let's Encrypt）

```bash
# 安装 Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

## 五、前端部署

### 1. 修改配置

在本地开发环境修改以下配置：

**frontend/src/utils/request.ts**
```typescript
const BASE_URL = 'https://your-domain.com/api';
```

**frontend/src/manifest.json**
```json
{
  "mp-weixin": {
    "appid": "你的小程序AppID"
  }
}
```

### 2. 构建小程序

```bash
cd frontend
npm install
npm run build:mp-weixin
```

### 3. 上传到微信平台

1. 使用微信开发者工具打开 `frontend/dist/build/mp-weixin` 目录
2. 点击"上传"按钮
3. 填写版本号和备注
4. 在微信公众平台提交审核

### 4. 配置服务器域名

在[微信公众平台](https://mp.weixin.qq.com/)：
1. 进入"开发" -> "开发管理" -> "开发设置"
2. 配置"服务器域名"：
   - request 合法域名：`https://your-domain.com`
   - uploadFile 合法域名：（如需上传文件功能）
   - downloadFile 合法域名：（如需下载文件功能）

## 六、监控和维护

### 1. 日志管理

```bash
# 查看后端日志
pm2 logs accounting-backend

# 查看 Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 查看 MySQL 日志
sudo tail -f /var/log/mysql/error.log
```

### 2. 数据库备份

```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-db.sh

# 添加内容：
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/mysql"
mkdir -p $BACKUP_DIR
mysqldump -u accounting_user -p'your_password' accounting_miniapp > $BACKUP_DIR/backup_$DATE.sql
# 删除 7 天前的备份
find $BACKUP_DIR -name "backup_*.sql" -mtime +7 -delete

# 设置权限
sudo chmod +x /usr/local/bin/backup-db.sh

# 设置定时任务（每天凌晨 2 点备份）
crontab -e
# 添加：
0 2 * * * /usr/local/bin/backup-db.sh
```

### 3. 性能监控

```bash
# 安装监控工具
sudo npm install -g pm2-logrotate
pm2 install pm2-logrotate

# 查看系统资源
pm2 monit

# 查看进程状态
pm2 status
```

## 七、常见问题

### 1. 端口被占用

```bash
# 查看端口占用
sudo lsof -i :3000
sudo kill -9 <PID>
```

### 2. 数据库连接失败

- 检查数据库是否启动：`sudo systemctl status mysql`
- 检查用户权限：`SHOW GRANTS FOR 'accounting_user'@'localhost';`
- 检查防火墙：`sudo ufw status`

### 3. PM2 进程异常退出

```bash
# 查看错误日志
pm2 logs accounting-backend --err

# 重启进程
pm2 restart accounting-backend
```

### 4. Nginx 502 错误

- 检查后端服务是否运行：`pm2 status`
- 检查 Nginx 配置：`sudo nginx -t`
- 查看 Nginx 错误日志：`sudo tail -f /var/log/nginx/error.log`

## 八、安全建议

1. **定期更新系统和软件包**
   ```bash
   sudo apt-get update
   sudo apt-get upgrade
   ```

2. **使用强密码**
   - 数据库密码
   - JWT Secret
   - 服务器 SSH 密码

3. **配置 SSH 密钥登录**
   - 禁用密码登录
   - 只允许密钥登录

4. **配置防火墙规则**
   - 只开放必要端口
   - 限制 SSH 访问 IP

5. **定期备份数据**
   - 数据库备份
   - 代码备份
   - 配置文件备份

6. **监控异常访问**
   - 查看访问日志
   - 设置异常告警

## 九、性能优化

1. **数据库优化**
   - 添加必要索引
   - 定期清理过期数据
   - 优化查询语句

2. **后端优化**
   - 使用连接池
   - 添加 Redis 缓存（可选）
   - 启用 Gzip 压缩

3. **前端优化**
   - 图片压缩
   - 代码分包
   - 懒加载

## 十、更新部署

```bash
# 拉取最新代码
cd /var/www/accounting-miniapp/backend
git pull

# 安装新依赖（如果有）
npm install

# 重新编译
npm run build

# 重启服务
pm2 restart accounting-backend

# 重启 Nginx（如果配置有变化）
sudo systemctl restart nginx
```

## 联系支持

如遇到部署问题，请查看项目文档或提交 Issue。

