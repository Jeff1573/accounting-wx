# 项目架构说明

本文档详细说明记账小程序的架构设计、技术选型和实现细节。

## 一、整体架构

### 1. 系统架构图

```
┌─────────────────────────────────────────────────────┐
│                   微信小程序                          │
│  ┌─────────────────────────────────────────────┐   │
│  │         前端 (uni-app + Vue 3)              │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐ │   │
│  │  │ 页面层   │  │ 组件层   │  │ 工具层   │ │   │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘ │   │
│  │       │             │             │        │   │
│  │  ┌────┴──────────────┴─────────────┴────┐ │   │
│  │  │        Pinia 状态管理               │ │   │
│  │  └────────────────┬────────────────────┘ │   │
│  │                   │                       │   │
│  │  ┌────────────────┴────────────────────┐ │   │
│  │  │        HTTP 请求封装 (Axios)        │ │   │
│  │  └──────────────────────────────────────┘ │   │
│  └─────────────────┼───────────────────────────┘   │
└────────────────────┼─────────────────────────────┘
                     │ REST API (HTTPS)
┌────────────────────┼─────────────────────────────┐
│                    ▼                              │
│               Nginx (反向代理)                     │
│                    │                              │
│  ┌─────────────────┼───────────────────────────┐ │
│  │                 ▼                           │ │
│  │      Express.js 后端服务 (Node.js)          │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐ │ │
│  │  │ 路由层   │  │ 控制层   │  │ 服务层   │ │ │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘ │ │
│  │       │             │             │        │ │
│  │  ┌────┴──────────────┴─────────────┴────┐ │ │
│  │  │        中间件 (认证/日志/错误)        │ │ │
│  │  └────────────────┬────────────────────┘ │ │
│  │                   │                       │ │
│  │  ┌────────────────┴────────────────────┐ │ │
│  │  │      Sequelize ORM                  │ │ │
│  │  └──────────────────────────────────────┘ │ │
│  └──────────────────┼─────────────────────────┘ │
└─────────────────────┼───────────────────────────┘
                      │
┌─────────────────────┼───────────────────────────┐
│                     ▼                           │
│              MySQL 8.0 数据库                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │  users   │  │  rooms   │  │room_members│    │
│  └──────────┘  └──────────┘  └──────────┘     │
│  ┌──────────────────────────┐                 │
│  │     transactions         │                 │
│  └──────────────────────────┘                 │
└──────────────────────────────────────────────┘

            ┌──────────────────┐
            │  微信开放平台     │
            │  (OAuth 登录)    │
            └──────────────────┘
```

## 二、前端架构

### 1. 技术栈

- **框架**: uni-app (基于 Vue 3)
- **语言**: TypeScript
- **状态管理**: Pinia
- **构建工具**: Vite
- **UI**: 自定义组件 + uni-ui

### 2. 目录结构

```
frontend/src/
├── api/                  # API 接口层
│   ├── auth.ts          # 认证 API
│   ├── room.ts          # 房间 API
│   └── transaction.ts   # 交易 API
├── components/           # 公共组件
│   ├── MemberCard.vue   # 成员卡片
│   └── TransactionItem.vue # 交易项
├── pages/               # 页面
│   ├── login/           # 登录页
│   ├── rooms/           # 房间列表
│   ├── room-detail/     # 房间详情
│   └── transaction/     # 转账页
├── stores/              # 状态管理
│   ├── user.ts         # 用户状态
│   └── room.ts         # 房间状态
├── utils/               # 工具函数
│   ├── request.ts      # HTTP 封装
│   └── format.ts       # 格式化
├── App.vue             # 根组件
├── main.ts             # 入口文件
├── manifest.json       # 应用配置
└── pages.json          # 页面配置
```

### 3. 数据流

```
用户操作 → 页面组件 → API 调用 → HTTP 请求 → 后端接口
         ↓
      更新 Store
         ↓
      组件重新渲染
```

### 4. 状态管理

使用 Pinia 管理全局状态：

- **User Store**: 用户信息、登录状态
- **Room Store**: 当前房间、成员列表、交易记录

### 5. 路由设计

```
/pages/login/index          # 登录页
/pages/rooms/index          # 房间列表（首页）
/pages/room-detail/index    # 房间详情
/pages/transaction/index    # 转账页
```

## 三、后端架构

### 1. 技术栈

- **框架**: Express.js
- **语言**: TypeScript
- **数据库**: MySQL 8.0
- **ORM**: Sequelize
- **认证**: JWT
- **运行时**: Node.js

### 2. 目录结构

```
backend/src/
├── config/              # 配置
│   └── database.ts     # 数据库配置
├── models/              # 数据模型
│   ├── User.ts         # 用户模型
│   ├── Room.ts         # 房间模型
│   ├── RoomMember.ts   # 成员模型
│   ├── Transaction.ts  # 交易模型
│   └── index.ts        # 模型关联
├── controllers/         # 控制器
│   ├── authController.ts
│   ├── roomController.ts
│   └── transactionController.ts
├── routes/              # 路由
│   ├── auth.ts
│   ├── rooms.ts
│   └── transactions.ts
├── middleware/          # 中间件
│   └── auth.ts         # JWT 认证
├── utils/               # 工具函数
│   ├── jwt.ts          # JWT 工具
│   ├── wechat.ts       # 微信 API
│   └── inviteCode.ts   # 邀请码生成
└── app.ts               # 应用入口
```

### 3. 分层架构

```
Routes (路由层)
    ↓
Middleware (中间件层)
    ↓
Controllers (控制器层)
    ↓
Models (模型层)
    ↓
Database (数据库层)
```

### 4. API 设计

遵循 RESTful 规范：

```
POST   /api/auth/wx-login              # 微信登录
GET    /api/auth/me                    # 获取当前用户

POST   /api/rooms                      # 创建房间
POST   /api/rooms/join                 # 加入房间
GET    /api/rooms                      # 获取房间列表
GET    /api/rooms/:id                  # 获取房间详情
PUT    /api/rooms/:id/members/:mid     # 更新成员昵称

POST   /api/rooms/:id/transactions     # 创建交易
GET    /api/rooms/:id/transactions     # 获取交易列表
GET    /api/rooms/:id/balances         # 获取余额统计
```

### 5. 认证流程

```
1. 前端调用 wx.login() 获取 code
2. 前端将 code 发送到后端
3. 后端使用 code 调用微信 API 获取 openid
4. 后端查询或创建用户
5. 后端生成 JWT token 返回前端
6. 前端存储 token
7. 后续请求在 Header 中携带 token
8. 后端中间件验证 token
```

## 四、数据库设计

### 1. ER 图

```
┌─────────────┐
│   Users     │
│─────────────│
│ id (PK)     │
│ wx_openid   │◄────┐
│ wx_nickname │     │
│ wx_avatar   │     │
└─────────────┘     │
       │            │
       │ 1:N        │
       ▼            │
┌─────────────┐     │
│   Rooms     │     │
│─────────────│     │
│ id (PK)     │     │
│ name        │     │
│ creator_id  │─────┘
│ invite_code │
└─────────────┘
       │
       │ 1:N
       ▼
┌──────────────┐
│ RoomMembers  │
│──────────────│
│ id (PK)      │
│ room_id (FK) │
│ user_id (FK) │
│ custom_name  │
└──────────────┘
       │
       │ 1:N
       ▼
┌──────────────────┐
│  Transactions    │
│──────────────────│
│ id (PK)          │
│ room_id (FK)     │
│ payer_id (FK)    │
│ payee_id (FK)    │
│ amount           │
│ created_at       │
└──────────────────┘
```

### 2. 表关系

- User 1:N Room (创建者)
- User N:M Room (通过 RoomMember)
- Room 1:N RoomMember
- Room 1:N Transaction
- User 1:N Transaction (付款人)
- User 1:N Transaction (收款人)

### 3. 索引设计

- `users.wx_openid` (唯一索引)
- `rooms.invite_code` (唯一索引)
- `room_members.(room_id, user_id)` (联合唯一索引)
- `transactions.room_id` (普通索引)
- `transactions.created_at` (普通索引)

## 五、核心业务逻辑

### 1. 余额计算

```typescript
用户余额 = Σ(作为收款人的金额) - Σ(作为付款人的金额)

// SQL 实现
SELECT 
  user_id,
  SUM(CASE WHEN payee_id = user_id THEN amount ELSE 0 END) -
  SUM(CASE WHEN payer_id = user_id THEN amount ELSE 0 END) as balance
FROM transactions
WHERE room_id = ?
GROUP BY user_id
```

### 2. 邀请码生成

- 使用 nanoid 生成 6 位随机字符串
- 字符集：0-9 + A-Z (排除易混淆字符 I、O)
- 数据库唯一索引保证不重复

### 3. 权限控制

- 所有 API (除登录外) 需要 JWT 认证
- 只能访问自己加入的房间
- 只能修改自己的昵称
- 只能以自己为付款人创建交易

## 六、安全设计

### 1. 认证与授权

- JWT token 有效期 7 天
- Token 过期自动跳转登录
- 中间件验证 token 有效性
- 数据库存储加密密钥（JWT Secret）

### 2. 数据验证

- 后端所有输入都进行验证
- 金额必须大于 0
- 房间名称不能为空
- 邀请码格式验证

### 3. SQL 注入防护

- 使用 Sequelize ORM
- 参数化查询
- 自动转义特殊字符

### 4. XSS 防护

- 前端显示时转义特殊字符
- 不执行用户输入的脚本
- CSP 策略

## 七、性能优化

### 1. 数据库优化

- 适当的索引
- 避免 N+1 查询
- 使用连接池
- 分页查询

### 2. 后端优化

- 异步处理
- 缓存常用数据（可选）
- Gzip 压缩
- 日志异步写入

### 3. 前端优化

- 组件懒加载
- 图片懒加载
- 请求防抖
- 本地缓存

## 八、可扩展性

### 1. 后续功能扩展

- [ ] 自定义成员昵称
- [ ] 交易分类和备注
- [ ] 数据统计和报表
- [ ] 导出 Excel
- [ ] 删除/编辑交易
- [ ] 房间公告
- [ ] 消息推送
- [ ] 多币种支持

### 2. 技术扩展

- [ ] Redis 缓存
- [ ] WebSocket 实时通信
- [ ] 消息队列
- [ ] 微服务化
- [ ] Docker 容器化
- [ ] CI/CD 自动化部署

## 九、监控与日志

### 1. 日志级别

- **Error**: 错误日志
- **Warn**: 警告日志
- **Info**: 信息日志
- **Debug**: 调试日志

### 2. 监控指标

- API 响应时间
- 数据库查询时间
- 错误率
- 用户活跃度
- 房间创建数
- 交易记录数

## 十、总结

本项目采用前后端分离架构，使用现代化技术栈，具有良好的可维护性和可扩展性。代码结构清晰，职责分明，易于理解和修改。

