# 真机调试配置指南

## 📱 问题说明

真机调试时出现 `net::ERR_CONNECTION_REFUSED` 错误，是因为手机无法访问 `localhost`，需要使用局域网 IP。

---

## ✅ 解决方案（已配置完成）

### 1. 后端配置（已完成✓）

后端已配置为绑定到 `0.0.0.0`，支持局域网访问。

**文件：** `backend/src/app.ts`

```typescript
app.listen(PORT, '0.0.0.0', () => {
  // 现在可以通过局域网 IP 访问
});
```

### 2. 前端配置（需要你操作）

**文件：** `frontend/src/config/env.ts`

---

## 🚀 真机调试操作步骤

### 第一步：获取你的电脑局域网 IP

#### Mac/Linux 系统：
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

#### Windows 系统：
```bash
ipconfig
```

找到类似 `192.168.1.100` 的 IP 地址（注意不是 127.0.0.1）

### 第二步：修改前端配置

打开 `frontend/src/config/env.ts`，修改以下两处：

```typescript
// 1. 修改局域网 IP（改为你的 IP）
const DEVICE_API_BASE_URL = 'http://192.168.1.100:3000/api';
//                                 ^^^^^^^^^^^^^^^^
//                                 改为你的电脑 IP

// 2. 开启使用局域网 IP
export default {
  USE_DEVICE_IP: true,  // 改为 true
  // ...
};
```

### 第三步：重启服务

```bash
# 1. 重启后端服务器
cd backend
npm run dev

# 2. 重新编译前端
cd frontend
npm run dev:mp-weixin
```

### 第四步：微信开发者工具配置

1. 打开微信开发者工具
2. 点击右上角 "详情"
3. 在 "本地设置" 中，勾选：
   - ✓ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
4. 重新编译运行

### 第五步：真机预览

1. 点击微信开发者工具的 "预览" 按钮
2. 用手机微信扫码
3. 确保手机和电脑在**同一个 WiFi 网络**下

---

## 📝 配置说明

### 开发环境切换

| 环境 | USE_DEVICE_IP | 访问地址 |
|------|---------------|----------|
| 开发者工具调试 | `false` | `http://localhost:3000/api` |
| 真机调试 | `true` | `http://你的IP:3000/api` |
| 生产环境 | - | `https://域名/api` |

### 配置文件结构

```
frontend/src/config/env.ts
├── DEV_API_BASE_URL       # 开发环境（localhost）
├── DEVICE_API_BASE_URL    # 真机调试（局域网 IP）
└── PROD_API_BASE_URL      # 生产环境（域名）
```

---

## ⚠️ 注意事项

1. **网络要求**
   - 手机和电脑必须在同一个 WiFi 网络
   - 不能使用移动数据（4G/5G）

2. **防火墙设置**
   - Mac: 系统偏好设置 → 安全性与隐私 → 防火墙 → 允许 Node.js
   - Windows: 控制面板 → 防火墙 → 允许应用通过防火墙 → Node.js

3. **端口占用**
   - 确保 3000 端口没有被其他程序占用
   - 可以通过修改 `backend/.env` 中的 `PORT` 来更改端口

4. **调试完成后**
   - 记得将 `USE_DEVICE_IP` 改回 `false`
   - 避免在开发者工具中使用局域网 IP（速度会较慢）

---

## 🔍 问题排查

### 问题 1：手机仍然无法连接

**检查清单：**
- [ ] 手机和电脑是否在同一个 WiFi？
- [ ] IP 地址是否正确？
- [ ] 后端服务器是否正常运行？
- [ ] 防火墙是否允许？

**测试方法：**
在手机浏览器访问：`http://你的IP:3000/health`

如果能看到 `{"status":"ok"}` 说明服务器正常。

### 问题 2：开发者工具能访问，真机不能

说明配置正确，但网络不通：
1. 检查防火墙设置
2. 检查路由器设置（某些路由器禁止设备互联）
3. 尝试重启 WiFi 路由器

### 问题 3：频繁报错 timeout

局域网信号较弱，可以：
1. 增加超时时间（修改 `env.ts` 中的 `REQUEST_TIMEOUT`）
2. 靠近路由器
3. 切换到 5G WiFi（如果支持）

---

## 💡 最佳实践

1. **开发流程**
   ```
   功能开发（开发者工具）→ 真机测试（局域网）→ 上线部署（域名）
   ```

2. **配置管理**
   - 不要把局域网 IP 提交到 Git
   - 可以在 `.gitignore` 中添加个人配置文件

3. **性能优化**
   - 真机调试时建议使用 5G WiFi
   - 减少不必要的 console.log 输出
   - 使用防抖节流优化频繁请求

---

## 📚 相关文档

- [uni-app 真机调试文档](https://uniapp.dcloud.net.cn/tutorial/run/run-app.html)
- [微信小程序真机调试](https://developers.weixin.qq.com/miniprogram/dev/devtools/remote-debug.html)
- [Express 配置文档](https://expressjs.com/zh-cn/api.html)

